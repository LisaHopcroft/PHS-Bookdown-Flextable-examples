---
title: "Bookdown example"
site: bookdown::bookdown_site
author: "Lisa Hopcroft"
date: "November 2019"
output:
  bookdown::word_document2:
    toc: yes
    toc_depth: 2
    reference_docx: H:\Projects\Reference\DMC_formatting_reference\DMC_formatting_reference_file-01-draft.docx
---

```{r knitr_options, echo=FALSE}
knitr::opts_chunk$set( fig.width =6,
                       fig.height=4,
                       ft.align="left",
                       # fig.align ="center",
                       echo      =FALSE,
                       message   =FALSE,
                       warning   =FALSE,
                       error     =FALSE )
```

```{r library_imports}
# require( readr )
# require( ggrepel )
# require( tidyverse )
# require( stringr )
# require( rmarkdown )
# require( psych )
# require( magrittr )
# require( RColorBrewer )
# require( png )
# require( jpeg )
# require( grid )
# require( gridExtra )
# require( pander )
# library( xml2 )

require( tidyverse )
require( lubridate )
require( knitr ) # include_graphics()
require( flextable )
require( officer ) # fp_border() - formatting flextables


# Add variables that will be used repeatedly

```

```{r table_formatting}
# options(knitr.kable.NA = '-')

tbl_border.standard = fp_border(color="black", width = 1)
tbl_border.heavy    = fp_border(color="black", width = 2)

tbl_fill.colours = c(
"grey"   = "#D3D3D3",
"yellow" = "#F9E79F",
"red"    = "#F5B7B1"
)

```




<!--chapter:end:index.Rmd-->

```{r dummy_data_generation}

###
### Setting up variables Variables to generate the dummy data
###

# set.seed( 5482 )

number_of_patients = 20

start_of_trial = ymd( "2015-01-01" )
end_of_trial   = start_of_trial + years(5)

drug_treatment = c( "Drug A",
                    "Drug B",
                    "Drug A+B" )

endpoint_1_minimum = -50
endpoint_1_maximum =  50

endpoint_2_minimum = 0
endpoint_2_maximum = 20


###
### Generating the dataset using these variables
###

trial_data = tibble(
  patient           = sprintf( "N%04d", 1:number_of_patients),
  date_of_treatment = sample( seq(start_of_trial,
                                  end_of_trial,
                                  by = "day"),
                              number_of_patients ),
  drug_treatment    = sample( drug_treatment,
                              number_of_patients,
                              replace = TRUE),
  primary_endpoint_1  =  runif(number_of_patients,
                               endpoint_1_minimum,
                               endpoint_1_maximum),
  primary_endpoint_2  =  runif(number_of_patients,
                               endpoint_2_minimum,
                               endpoint_2_maximum)
)

```

<!--chapter:end:00_data-import.Rmd-->

```{r dummy_data_clean}

###
### Cleaning the data
###

### (1) Change the drug names
drug_treatment_update = c(
  "Drug A" = "Drug X",
  "Drug B" = "Drug Y",
  "Drug A+B" = "Drug X+Y"
)
### (2) "Lose" some data
missing_mask = sample(1:number_of_patients, 5)

new_primary_endpoint_1 = trial_data$primary_endpoint_1
new_primary_endpoint_1[ missing_mask ] = NA 

new_primary_endpoint_2 = trial_data$primary_endpoint_2
new_primary_endpoint_2[ missing_mask ] = NA 

###
### Update the dataset
###

trial_data.clean = trial_data %>%
  mutate( drug_treatment = recode( drug_treatment,
                                   "Drug A" = "Drug X",
                                   "Drug B" = "Drug Y",
                                   "Drug A+B" = "Drug X+Y" ) ) %>%
  mutate( primary_endpoint_1 = new_primary_endpoint_1,
          primary_endpoint_2 = new_primary_endpoint_2 )



```

<!--chapter:end:01_data-clean.Rmd-->

```{r report_information}
REPORT.author    = "Lisa Hopcroft"
REPORT.organisation = "SCTRU / PHI-CKRS"
REPORT.author.email = "Lisa.Hopcroft1@nhs.net"
REPORT.author.phone = "0141 282 2119"

theme_NAXIVA = theme_bw() +
  theme( axis.title = element_text( face = "bold" ),
         axis.text.x = element_text( angle=90,
                                     vjust=0,
                                     hjust=0.5) )
```

<!--chapter:end:10_report-information.Rmd-->

```{r banner}
include_graphics(path = "img/nhs-nss_logo.png")
```

# Trial report

Here is some information about the trial report.

|               |                         |
| ------------- | ----------------------- |
| Name          | `r REPORT.author`       |
| Affiliation   | `r REPORT.organisation` |
| Email address | `r REPORT.author.email` |
| Phone         | `r REPORT.author.phone` |


<!--chapter:end:11_report-titlepage.Rmd-->

# Presentation of data

Here is our trial data, presented using `knitr::kable()`.

```{r data_presentation_kable}
kable( trial_data.clean )
```

There are some things that we can't do using kable.
This includes:

 * merging cells in the header
 * conditional formatting (font colour, fill, style etc.)
 * dynamic formatting (i.e., changes with value in a variable)
 * white space within cells (useful for subtypes) - not covered here

```{r data_presentation_flextable}

trial_data.flextable = flextable( trial_data.clean ) %>%
  ### Formatting datatypes consistently
  set_formatter_type( fmt_date    = "%d-%m-%Y",
                      fmt_double  = "%.02f",
                      fmt_integer = "%.0f",
                      na_str      = "-" ) %>%
  ### Autofit contents
  # autofit() %>%

  ### Formatting column headings
  set_header_labels(values=c(
    "patient"            = "Patient",
    "date_of_treatment"  = "Treatment date",
    "drug_treatment"     = "Treatment",
    "primary_endpoint_1" = "(1)",
    "primary_endpoint_2" = "(2)"
  )) %>%
  
  ### Merging cells
  add_header_row( values   =c("","","","Primary endpoints"),
                  colwidths=c( 1, 1, 1,                  2) ) %>%
  
  ### Formatting cells (borders, background)
  bg( part="header", bg="grey" ) %>%
  bold( bold = TRUE, part = "header" ) %>%
  align(align = "center", part="header", i=1) %>%
  border_remove() %>%
  hline_top(part="header",border=tbl_border.heavy) %>%
  hline_top( part="body", border=tbl_border.heavy) %>%
  hline_bottom( part="body", border=tbl_border.heavy) %>%
  border(i=1,j=4:5,part="header", border.bottom = tbl_border.standard)

print( trial_data.flextable, preview="docx" )

```

```{r data_presentation_conditional_formatting}

highlight_colour.yellow = "#F9E79F"
highlight_colour.red    = "#F5B7B1"

trial_data.flextable %>%
  # bg( i=~primary_endpoint_1<0, bg=highlight_colour.yellow ) %>%
  # bg( i=~primary_endpoint_2>5, bg=highlight_colour.red    ) %>%
  # bg( i = ~ primary_endpoint_1 < 0 & primary_endpoint_2 > 5,
      # bg=highlight_colour.yellow ) %>%
  # bg( i = ~ primary_endpoint_1 < 0 & primary_endpoint_2 > 5,
  #     j = ~ primary_endpoint_1 + primary_endpoint_2,
  #     bg=highlight_colour.yellow ) %>%
  color(i = ~ is.na(primary_endpoint_1) & is.na(primary_endpoint_2), 
        color="grey")

```


```{r data_presentation_dynamic_formatting}

highlight_colour.blue = "#85C1E9"

primary_endpoint_1.mean = mean( trial_data.clean$primary_endpoint_1, na.rm=TRUE )
primary_endpoint_2.mean = mean( trial_data.clean$primary_endpoint_2, na.rm=TRUE )

trial_data.flextable %>%
  
  bg( i = ~ primary_endpoint_1 > primary_endpoint_1.mean,
      j = ~ primary_endpoint_1,
      bg=highlight_colour.blue ) %>%
  
  bg( i = ~ primary_endpoint_2 > primary_endpoint_2.mean,
      j = ~ primary_endpoint_2,
      bg=highlight_colour.blue ) %>%
  
  color(i = ~ is.na(primary_endpoint_1) & is.na(primary_endpoint_2), 
        color="grey")

```

<!--chapter:end:20_data-presentation.Rmd-->

